---
title: "CVE-2023-6080 A Case Study on Third-Party Installer Abuse"
date: Mon, 03 Feb 2025 13:00:00 +0000
draft: false
type: posts
categories: 
- Threat Intelligence
---
# CVE-2023-6080 A Case Study on Third-Party Installer Abuse

<br/>

<br/>
Written By: Jacob Paullus, Daniel McNamara, Jake Rawlins, Steven Karschnia

* * *

Executive Summary
-----------------

-   Mandiant exploited flaws in the Microsoft Software Installer (MSI) repair action of Lakeside Software's SysTrack installer to obtain arbitrary code execution.
    
-   An attacker with low-privilege access to a system running the vulnerable version of SysTrack could escalate privileges locally.
    
-   Mandiant responsibly disclosed this vulnerability to Lakeside Software, and the issue has been addressed in version 11.0.
    

Introduction
------------

Building upon the insights shared in a previous Mandiant blog post, [Escalating Privileges via Third-Party Windows Installers](https://cloud.google.com/blog/topics/threat-intelligence/privileges-third-party-windows-installers/), this case study explores the ongoing challenge of securing third-party Windows installers. These vulnerabilities are rooted in insecure coding practices when creating Microsoft Software Installer (MSI) Custom Actions and can be caused by references to missing files, broken shortcuts, or insecure folder permissions. These oversights create gaps that inadvertently allow attackers the ability to escalate privileges.

As covered in our previous blog post, after software is installed with an MSI file, Windows caches the MSI file in the `C:\Windows\Installer` folder for later use. This allows users on the system to access and use the "repair" feature, which is intended to address various issues that may be impacting the installed software. During execution of an MSI repair, several operations (such as file creation or execution) may be triggered from an `NT AUTHORITY\SYSTEM` context, even if initiated by a low-privilege user, thereby creating privilege escalation opportunities.

This blog post specifically focuses on the discovery and exploitation of CVE-2023-6080, a local privilege escalation vulnerability that Mandiant identified in Lakeside Software's SysTrack Agent version 10.7.8.

Exploiting the SysTrack Installer
---------------------------------

Mandiant began by using [Microsoft's Process Monitor (ProcMon)](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon) to analyze and review file operations executed during the repair process of SysTrack's MSI. While running the repair process as a low-privileged user, Mandiant observed file creation and execution within the user's `%TEMP%` folder from `MSIExec.exe`.

![MSIExec.exe copying and executing .tmp file in user's %TEMP% folder](https://storage.googleapis.com/gweb-cloudblog-publish/images/cve-2023-6080-fig1.max-1000x1000.png)

Figure 1: MSIExec.exe copying and executing .tmp file in user's %TEMP% folder

Each time Mandiant ran the repair functionality, `MSIExec.exe` wrote a new `.tmp` file to the `%TEMP%` folder using a formula-based name, and then executed it. Mandiant discovered, through dynamic analysis of the installer, that the name generated by the repair function would consist of the string "wac" followed by four randomly chosen hex characters (0-9, A-F). With this naming scheme, there were 65,535 possible filename options.

Due to the `%TEMP%` folder being writable by a low-privilege user, Mandiant tested the behavior of the repair tool when all possible filenames already existed within the `%TEMP%` folder. Mandiant created a PowerShell script to copy an arbitrary test executable to each possible file name in the range of `wac0000.tmp` to `wacFFFF.tmp`.

```
# Path to the permutations file
$csvFilePath = ‘.\permutations.csv’

# Path to the executable
$exePath = ‘.\test.exe’

# Target directory (using the system’s temp directory)
$targetDirectory = [System.IO.Path]::GetTempPath()

# Read the csv file content
$csvContent = Get-Content -Path $csvFilePath

# Split the content into individual values
$values = $csvContent -split “,”

# Loop through each value and copy the exe to the target directory with the new name
Foreach ($value in $values) {
	$newFilePath = Join-Path -Path $targetDirectory -ChildPath ($value + “.tmp”)
	Copy-Item -Path $exePath -Destination $newFilePath
}

Write-Output “Copy operation completed to $targetDirectory”
```

Figure 2: Creating all possible .tmp files in %TEMP%

![Excerpt of .tmp files created in %TEMP%](https://storage.googleapis.com/gweb-cloudblog-publish/images/cve-2023-6080-fig3.max-1000x1000.png)

Figure 3: Excerpt of .tmp files created in %TEMP%

After filling the previously identified namespace, Mandiant reran the MSI repair function to observe its subsequent behavior. Upon review of the ProcMon output, Mandiant observed that when the namespace was filled, the application would failover to an incrementing filename pattern. The pattern began with `wac1.tmp` and incremented the number each time in a predictable pattern, if the previous file existed. To prove this theory, Mandiant manually created `wac1.tmp` and `wac2.tmp`, then observed the MSI repair action in ProcMon. When running the MSI repair function, the resulting filename was `wac3.tmp`.

![MSIExec.exe writing and executing a predicted .tmp file](https://storage.googleapis.com/gweb-cloudblog-publish/images/cve-2023-6080-fig4.max-1000x1000.png)

Figure 4: MSIExec.exe writing and executing a predicted .tmp file

Additionally, Mandiant observed that there was a small delay between the file write action and the file execution action, which could potentially result in a race condition vulnerability. Since Mandiant could now force the program to use a predetermined filename, Mandiant wrote another PowerShell script designed to attempt to win the race condition by copying a file (`test.exe`) to the `%TEMP%` folder, using the predicted filename, between the file write and execution in order to overwrite the file created by `MSIExec.exe`. In this test, `test.exe` was a simple proof-of-concept executable that would start `cmd.exe`.

```
while ($true) {
if (Test-Path -Path "C:\Users\USER\AppData\Local\Temp\wac3.tmp") {
		Copy-Item -Path "C:\Users\USER\Desktop\test.exe" -Destination 
"C:\Users\USER\AppData\Local\Temp\wac3.tmp" -Force
	}
}
```

Figure 5: PowerShell race condition script to copy arbitrary file into %TEMP%

With the `%TEMP%` folder prepared with the `wac1.tmp` and `wac2.tmp` files created, Mandiant ran both the PowerShell script and MSI repair action targeting `wac3.tmp`. With the race condition script running, execution of the repair action resulted in the `test.exe` file overwriting the intended binary and subsequently being executed by `MSIExec.exe`, opening `cmd.exe` as `NT AUTHORITY\SYSTEM`.

![Obtaining NT\ AUTHORITY SYSTEM command prompt](https://storage.googleapis.com/gweb-cloudblog-publish/images/cve-2023-6080-fig6.max-1000x1000.png)

Figure 6: Obtaining NT\\ AUTHORITY SYSTEM command prompt

Defensive Considerations
------------------------

As discussed in Mandiant's previous blog post, misconfigured Custom Actions can be trivial to find and exploit, making them a significant security risk for organizations. It is essential for software developers to follow secure coding practices and review their implemented Custom Actions to prevent attackers from hijacking high-privilege operations triggered by the MSI repair functionality. Refer to the [original blog post](https://cloud.google.com/blog/topics/threat-intelligence/privileges-third-party-windows-installers/) for general best practices when configuring Custom Actions. In discovery of CVE-2023-6080, Mandiant identified several misconfigurations and oversights that allowed for privilege escalation to `NT AUTHORITY\SYSTEM`.

The SysTrack MSI performed file operations including creation and execution in the user's `%TEMP%` folder, which provides a low-privilege user the opportunity to alter files being actively used in a high-privilege context. Software developers should keep folder permissions in mind and ensure all privileged file operations are performed from folders that are appropriately secured. This can include altering the read/write permissions for the folder, or using built-in folders such as `C:\Program Files` or `C:\Program Files (x86)`, which are inherently protected from low-privilege users.

Additionally, the software's filename generation schema included a failover mechanism that allowed an attacker to force the application into using a predetermined filename. When using randomized filenames, developers should use a sufficiently large length to ensure that an attacker cannot exhaust all possible filenames and force the application into unexpected behavior. In this case, knowing the target filename before execution made it significantly easier to beat the race condition, as opposed to dynamically identifying and replacing the target file between the time of its creation by `MSIExec.exe` and the time of its execution.

Something security professionals must also consider is the safety of the programs running on corporate machines. Many approved applications may inadvertently contain security vulnerabilities that increase the risk in our environments. Mandiant recommends that companies consider auditing the security of their individual endpoints to ensure that defense in depth is maintained at an organizational level. Furthermore, where possible, companies should monitor the spawning of administrative shells such as `cmd.exe` and `powershell.exe` in an elevated context to alert on possible privilege escalation attempts.

A Final Word
------------

Domain privilege escalation is often the focus of security vendors and penetration tests, but it is not the only avenue for privilege escalation or compromise of data integrity in a corporate environment. Compromise of integrity on a single system can allow an attacker to mount further attacks throughout the network; for example, the [Network Access Account used by SCCM](https://posts.specterops.io/the-phantom-credentials-of-sccm-why-the-naa-wont-die-332ac7aa1ab9) can be compromised through a single workstation and when misconfigured can be used to escalate privileges within the domain and pivot to additional systems within the network.

Mandiant offers dedicated endpoint security assessments, during which customer endpoints are tested from multiple contexts, including the perspective of an adversary with low-privilege access attempting to escalate privileges. For more information about Mandiant's technical consulting services, including comprehensive endpoint security assessments, visit our [website](https://cloud.google.com/security/consulting/mandiant-technical-assurance).

We would like to extend a special thanks to Andrew Oliveau, who was a member of the testing team that discovered this vulnerability during his time at Mandiant.

CVE-2023-6080 Disclosure Timeline
---------------------------------

-   **June 13, 2024** - Vulnerability reported to Lakeside Software
    
-   **July 1, 2024** - Lakeside Software confirmed the vulnerability
    
-   **August 7, 2024** - Confirmed vulnerability fixed in version 11.0

#### [Source](https://cloud.google.com/blog/topics/threat-intelligence/cve-2023-6080-third-party-installer-abuse/)

<br/>
---
