---
title: "CVE-2024-57896 - Vulnerability: Intel Linux Kernels btrfs Delalloc Workers Use-After-Free"
date: 2025-01-15
categories: 
  - "cve"
  - "cybersecurity"
  - "cybersecurity-awareness"
  - "security"
  - "threat-intelligence"
tags: 
  - "cve"
  - "cybersecurity"
  - "security"
---

**CVE ID :** CVE-2024-57896  
**Published :** Jan. 15, 2025, 1:15 p.m. | 1 hour, 2 minutes ago  
**Description :** In the Linux kernel, the following vulnerability has been resolved:

btrfs: flush delalloc workers queue before stopping cleaner kthread during unmount

During the unmount path, at close\_ctree(), we first stop the cleaner kthread, using kthread\_stop() which frees the associated task\_struct, and then stop and destroy all the work queues. However after we stopped the cleaner we may still have a worker from the delalloc\_workers queue running inode.c:submit\_compressed\_extents(), which calls btrfs\_add\_delayed\_iput(), which in turn tries to wake up the cleaner kthread - which was already destroyed before, resulting in a use-after-free on the task\_struct.

Syzbot reported this with the following stack traces:

BUG: KASAN: slab-use-after-free in \_\_lock\_acquire+0x78/0x2100 kernel/locking/lockdep.c:5089 Read of size 8 at addr ffff8880259d2818 by task kworker/u8:3/52

CPU: 1 UID: 0 PID: 52 Comm: kworker/u8:3 Not tainted 6.13.0-rc1-syzkaller-00002-gcdd30ebb1b9f #0 Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024 Workqueue: btrfs-delalloc btrfs\_work\_helper Call Trace: \_\_dump\_stack lib/dump\_stack.c:94 \[inline\] dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:120 print\_address\_description mm/kasan/report.c:378 \[inline\] print\_report+0x169/0x550 mm/kasan/report.c:489 kasan\_report+0x143/0x180 mm/kasan/report.c:602 \_\_lock\_acquire+0x78/0x2100 kernel/locking/lockdep.c:5089 lock\_acquire+0x1ed/0x550 kernel/locking/lockdep.c:5849 \_\_raw\_spin\_lock\_irqsave include/linux/spinlock\_api\_smp.h:110 \[inline\] \_raw\_spin\_lock\_irqsave+0xd5/0x120 kernel/locking/spinlock.c:162 class\_raw\_spinlock\_irqsave\_constructor include/linux/spinlock.h:551 \[inline\] try\_to\_wake\_up+0xc2/0x1470 kernel/sched/core.c:4205 submit\_compressed\_extents+0xdf/0x16e0 fs/btrfs/inode.c:1615 run\_ordered\_work fs/btrfs/async-thread.c:288 \[inline\] btrfs\_work\_helper+0x96f/0xc40 fs/btrfs/async-thread.c:324 process\_one\_work kernel/workqueue.c:3229 \[inline\] process\_scheduled\_works+0xa66/0x1840 kernel/workqueue.c:3310 worker\_thread+0x870/0xd30 kernel/workqueue.c:3391 kthread+0x2f0/0x390 kernel/kthread.c:389 ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147 ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244

Allocated by task 2: kasan\_save\_stack mm/kasan/common.c:47 \[inline\] kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68 unpoison\_slab\_object mm/kasan/common.c:319 \[inline\] \_\_kasan\_slab\_alloc+0x66/0x80 mm/kasan/common.c:345 kasan\_slab\_alloc include/linux/kasan.h:250 \[inline\] slab\_post\_alloc\_hook mm/slub.c:4104 \[inline\] slab\_alloc\_node mm/slub.c:4153 \[inline\] kmem\_cache\_alloc\_node\_noprof+0x1d9/0x380 mm/slub.c:4205 alloc\_task\_struct\_node kernel/fork.c:180 \[inline\] dup\_task\_struct+0x57/0x8c0 kernel/fork.c:1113 copy\_process+0x5d1/0x3d50 kernel/fork.c:2225 kernel\_clone+0x223/0x870 kernel/fork.c:2807 kernel\_thread+0x1bc/0x240 kernel/fork.c:2869 create\_kthread kernel/kthread.c:412 \[inline\] kthreadd+0x60d/0x810 kernel/kthread.c:767 ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147 ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244

Freed by task 24: kasan\_save\_stack mm/kasan/common.c:47 \[inline\] kasan\_save\_track+0x3f/0x80 mm/kasan/common.c:68 kasan\_save\_free\_info+0x40/0x50 mm/kasan/generic.c:582 poison\_slab\_object mm/kasan/common.c:247 \[inline\] \_\_kasan\_slab\_free+0x59/0x70 mm/kasan/common.c:264 kasan\_slab\_free include/linux/kasan.h:233 \[inline\] slab\_free\_hook mm/slub.c:2338 \[inline\] slab\_free mm/slub.c:4598 \[inline\] kmem\_cache\_free+0x195/0x410 mm/slub.c:4700 put\_task\_struct include/linux/sched/task.h:144 \[inline\] delayed\_put\_task\_struct+0x125/0x300 kernel/exit.c:227 rcu\_do\_batch kernel/rcu/tree.c:2567 \[inline\] rcu\_core+0xaaa/0x17a0 kernel/rcu/tree.c:2823 handle\_softirqs+0x2d4/0x9b0 kernel/softirq.c:554 run\_ksoftirqd+0xca/0x130 kernel/softirq.c:943 ---truncated--- 
**Severity:** 0.0 | NA  
Visit the link for more details, such as CVSS details, affected products, timeline, and more...

Go to Source
