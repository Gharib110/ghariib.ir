<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Automating APT Scanning with Loki Scanner and Splunk</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
	==========================<br>
	== <a href="https://ghariib.ir/">Gharib Personal Blog</a> ==<br>
	==========================
	<div style="float: right;">A Techi Personal Blog</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Posts</b></a>.
			
			<a href="/categories/"><b>Categories</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Automating APT Scanning with Loki Scanner and Splunk</h1>
			<b><time>16.04.2017 22:32</time></b>
		       

			<div>
				<h1 id="automating-apt-scanning-with-loki-scanner-and-splunk">Automating APT Scanning with Loki Scanner and Splunk</h1>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<ul>
<li>Equation Group Malware (Hashes, Yara Rules by Kaspersky and 10 custom rules generated by us)</li>
<li>Carbanak APT - Kaspersky Report (Hashes, Filename IOCs - no service detection and Yara rules)</li>
<li>Arid Viper APT - Trendmicro (Hashes)</li>
<li>Anthem APT Deep Panda Signatures (not officialy confirmed) (krebsonsecurity.com - see Blog Post)</li>
<li>Regin Malware (GCHQ / NSA / FiveEyes) (incl. Legspin and Hopscotch)</li>
<li>Five Eyes QUERTY Malware (Regin Keylogger Module - see: Kaspesky Report)</li>
<li>Skeleton Key Malware (other state-sponsored Malware) - Source: Dell SecureWorks Counter Threat Unit(TM)</li>
<li>WoolenGoldfish - (SHA1 hashes, Yara rules) Trendmicro Report</li>
<li>OpCleaver (Iranian APT campaign) - Source: Cylance</li>
<li>More than 180 hack tool Yara rules - Source: APT Scanner THOR</li>
<li>More than 600 web shell Yara rules - Source: APT Scanner THOR</li>
<li>Numerous suspicious file name regex signatures - Source: APT Scanner THOR</li>
<li>Much more &hellip; (cannot update the list as fast as I include new signatures)</li>
</ul>
<p>The challenge with Loki is that it can be very laborious to run and parse Loki&rsquo;s scan results across an enterprise to find the needle in a haystack . In this post we&rsquo;ll show how to write a Splunk app to automate running Loki, parsing the results, and identifying what is important. But as an FYI, Loki is a CLI-based program that has the ability to scan a folder, your system, etc. for possible indicators of compromise. Basic Loki commands are:</p>
<pre tabindex="0"><code>usage: loki.exe [-h] [-p path] [-s kilobyte] [-l log-file] [-a alert-level]
                [-w warning-level] [-n notice-level] [--printAll]
                [--allreasons] [--noprocscan] [--nofilescan] [--noindicator]
                [--reginfs] [--dontwait] [--intense] [--csv] [--onlyrelevant]
                [--nolog] [--update] [--debug]    

Loki - Simple IOC Scanner    

optional arguments:
  -h, --help        show this help message and exit
  -p path           Path to scan
  -s kilobyte       Maximum file size to check in KB (default 2048 KB)
  -l log-file       Log file
  -a alert-level    Alert score
  -w warning-level  Warning score
  -n notice-level   Notice score
  --printAll        Print all files that are scanned
  --allreasons      Print all reasons that caused the score
  --noprocscan      Skip the process scan
  --nofilescan      Skip the file scan
  --noindicator     Do not show a progress indicator
  --reginfs         Do check for Regin virtual file system
  --dontwait        Do not wait on exit
  --intense         Intense scan mode (also scan unknown file types and all
                    extensions)
  --csv             Write CSV log format to STDOUT (machine prcoessing)
  --onlyrelevant    Only print warnings or alerts
  --nolog           Don&#39;t write a local log file
  --update          Update the signatures from the &#34;signature-base&#34; sub
                    repository
  --debug           Debug output
</code></pre><p>Before we begin with the steps to create the Splunk app, download the latest Loki Windows binary from <a href="https://github.com/Neo23x0/Loki/releases">here</a>. For the sake of this blog post we will only be focusing on running Loki in Windows, but the functionality can easily be extended to all operating systems. Once downloaded, run the command &ldquo;<em>loki.exe &ndash;update</em>&rdquo; to download the latest IOC files into the folder &ldquo;<em>signature-base</em>&rdquo; that will be used later.</p>
<p>On a side note, if you would like to further update your IOCs to include Alienware malicious IPs and domains and <a href="http://www.misp-project.org/">MISP</a> IOCs, use the signature update files located in &ldquo;<em>signature-base\threatintel</em>&rdquo;. You will require an API key from <a href="https://otx.alienvault.com/api/">Alienvault Open Threat Exchange</a> (OTX), and a MISP API key from a running <a href="http://www.misp-project.org/communities/">MISP instance</a>. The AlienVault API key is easy to get, the MISP instance is a little more difficult. In any case, once you have your keys you can write a script that updates either or both services and schedule a Cron job with the following commands:</p>
<pre tabindex="0"><code># Update AlienVault OTX:
  python get-otx-iocs.py -k &lt;API_KEY&gt;

# Update MISP:
  python get-misp-iocs.py -k &lt;API_KEY&gt; -u &lt;URL&gt;
</code></pre><p>Now that we have an updated Loki executable and signatures we are ready to create the Splunk App directory structure. In your Splunk Deployment Server create the following directories and files:</p>
<pre tabindex="0"><code>The following 
$SPLUNK_HOME/etc/deployment-apps/Splunk_App_loki
├── bin
|   
</code></pre><p>Now that we have our directory structure, there are a couple of default files that will need to be created that we&rsquo;ll run through quickly:</p>
<ol>
<li><strong>$SPLUNK_HOME\etc\deployment_apps\Splunk_App_loki\bin\signature-base\*</strong></li>
</ol>
<p># Copy the folder and its content created via the command &ldquo;<em>loki.exe &ndash;update</em>&ldquo;to the specified folder.</p>
<ol start="2">
<li><strong>$SPLUNK_HOME\etc\deployment_apps\Splunk_App_loki\bin\config\</strong><a href="https://github.com/Neo23x0/Loki/blob/master/config/excludes.cfg">excludes.cfg</a><br>
This is actually a Loki default file, but should be included none the less.</li>
</ol>
<p># Excluded directories</p>
<h1></h1>
<h1 id="ensure-that-you-have-the-latest-file-from-the-excludescfg-url-above">Ensure that you have the latest file from the excludes.cfg URL above.</h1>
<h1></h1>
<h1 id="--add-directories-you-want-to-exclude-from-the-scan">- add directories you want to exclude from the scan</h1>
<h1 id="--double-escape-back-slashes">- double escape back slashes</h1>
<h1 id="--values-are-case-insensitive">- values are case-insensitive</h1>
<h1 id="--remember-to-use-back-slashes-on-windows-and-slashes-on-linux--unix--osx">- remember to use back slashes on Windows and slashes on Linux / Unix / OSX</h1>
<h1 id="--each-line-contains-a-regex-that-matches-somewhere-in-the-full-path-case-insensitive">- each line contains a regex that matches somewhere in the full path (case insensitive)</h1>
<h1 id="eg">e.g.:</h1>
<h1 id="regex-system32">Regex: \\System32\\</h1>
<h1 id="matches-cwindowssystem32cmdexe">Matches C:\Windows\System32\cmd.exe</h1>
<h1></h1>
<h1 id="regex-varloglog">Regex: /var/log/[^/]+\.log</h1>
<h1 id="matches-varlogtestlog">Matches: /var/log/test.log</h1>
<h1 id="not-matches-varlogtestgz">Not Matches: /var/log/test.gz</h1>
<h1></h1>
<h1 id="useful-examples-google-antivirus-exclusion-recommendations-to-find-more">Useful examples (google &ldquo;antivirus exclusion recommendations&rdquo; to find more)</h1>
<p>\\Ntfrs\\
\\Ntds\\
\\EDB[^\.]+\.log
Sysvol\\Staging\\Nntfrs_cmp
\\System Volume Information\\DFSR</p>
<p><strong><em>$SPLUNK_HOME\etc\deployment_apps\Splunk_App_loki\default\<a href="http://docs.splunk.com/Documentation/Splunk/latest/Admin/Appconf">app.conf</a></em></strong><br>
The app.conf file maintains the state of a given app in Splunk Enterprise. It may also be used to customize certain aspects of an app.</p>
<p>## Splunk app configuration file</p>
<p>[install]
is_configured = true
state = enabled</p>
<p>[launcher]
author = epicism
version = 1.0
description = Technology Add-on for the Loki APT Scanner</p>
<p>[ui]
is_visible = false
label = Technology Add-on for Loki APT Scanner</p>
<p>[package]
id = Splunk_App_loki</p>
<p><strong><em>$SPLUNK_HOME\etc\deployment_apps\Splunk_App_loki\metadata\<a href="http://docs.splunk.com/Documentation/Splunk/latest/Admin/Defaultmetaconf">default.meta</a></em></strong><br>
The default.meta file contain ownership information, access controls, and export settings for Splunk objects like saved searches, event types, and views. Each app has its own default.meta file.</p>
<p>[]
access = read : [*], write: [ admin ]
export = system</p>
<p>Now that we have the default files out of the way we can create the Loki-specific configuration files. First is the inputs.conf file that runs the script that executes the loki.exe binary and reads the loki scan results.</p>
<p><strong><em>$SPLUNK_HOME\etc\deployment_apps\Splunk_</em><strong><strong><em>App</em></strong></strong><em>_loki\default\<a href="http://docs.splunk.com/Documentation/Splunk/latest/Admin/Inputsconf">inputs.conf</a></em></strong><br>
The inputs.conf file contains possible settings you can use to configure inputs, distributed inputs such as forwarders, and file system monitoring in inputs.conf.</p>
<p># This is where you would place your signature update script if you created it:</p>
<h1 id="scriptsplunk_homeetcappslokibinsignature-basethreatintelupdateintelbat">[script://$SPLUNK_HOME\etc\apps\loki\bin\signature-base\threatintel\updateintel.bat]</h1>
<h1 id="disabled--true">disabled = true</h1>
<h1 id="index--main">index = main</h1>
<h1 id="interval--30-1---">interval = 30 1 * * *</h1>
<h1 id="sourcetype--lokirun">sourcetype = lokirun</h1>
<h1 id="this-entry-runs-the-loki-batch-script-and-sends-the-script-output-to-a-null-index">This entry runs the loki batch script and sends the script output to a null index.</h1>
<h1 id="i-could-not-get-lokiexes-output-to-be-ingested-by-splunk-when-running-it-from-this-script">I could not get loki.exe&rsquo;s output to be ingested by Splunk when running it from this script,</h1>
<h1 id="so-i-routed-lokiexes-output-to-the-splunk_homelokilog-in-the-next-stanza">so I routed loki.exe&rsquo;s output to the $SPLUNK_HOME\&hellip;\loki.log in the next stanza.</h1>
<p>[script://$SPLUNK_HOME\etc\apps\Splunk_App_loki\bin\loki.bat]
disabled = false
index = main
interval = 0 0 2 * * ?
sourcetype = lokirun
queueSize = 50MB</p>
<h1 id="the-lokibat-batch-script-will-save-the-lokiexe-output-to-splunk_homevarloglokilog-and-this-reads-it">The loki.bat batch script will save the loki.exe output to $SPLUNK_HOME\var\log\loki.log, and this reads it.</h1>
<p>[monitor://$SPLUNK_HOME\var\log\splunk\loki.log]
disabled = false
index = loki
sourcetype = loki</p>
<p><strong><em>$SPLUNK_HOME\etc\deployment_apps\Splunk_</em><strong><strong><em>App</em></strong></strong><em>_loki\bin\loki.bat</em></strong><br>
This script moves its current working directory to the location of the script, overwrites loki.log to ensure that it doesn&rsquo;t grow endlessly and runs loki.exe. &ldquo;..\..\..\..\var\log\splunk\&rdquo; saves the output log in Splunk&rsquo;s log directory.</p>
<p>cd /d %~dp0</p>
<blockquote>
<p>..\..\..\..\var\log\splunk\loki.log echo.
start /low /d &ldquo;%~dp0&rdquo; loki.exe &ndash;reginfs &ndash;csv &ndash;dontwait &ndash;onlyrelevant &ndash;noindicator &ndash;intense -l ..\..\..\..\var\log\splunk\loki.log</p></blockquote>
<p>The following files are the configuration files used by the Splunk Search Head to parse the Loki log files. The Loki log files are supposed to be CSV format, but only the first half of the values are, which required me to be creative when parsing the event logs. Props.conf will parse the first half of the properly CSV separated log, and transforms.conf parses the rest of the line.</p>
<p><strong><em>$SPLUNK_HOME\etc\deployment_apps\Splunk_</em><strong><strong><em>App</em></strong></strong><em>_loki\default\<a href="http://docs.splunk.com/Documentation/Splunk/latest/Admin/Propsconf">props.conf</a></em></strong><br>
A little on Props.conf - it is commonly used for:</p>
<ul>
<li>Configuring line breaking for multi-line events;</li>
<li>Setting up character set encoding;</li>
<li>Allowing processing of binary files;</li>
<li>Configuring timestamp recognition;</li>
<li>Configuring event segmentation;</li>
<li>Overriding automated host and source type matching;</li>
<li>Configure advanced (regex-based) host and source type overrides;</li>
<li>Override source type matching for data from a particular source;</li>
<li>Set up rule-based source type recognition;</li>
<li>Rename source types;</li>
<li>And so on&hellip;</li>
</ul>
<p>Props.conf is an integral part of a Splunk app, and I recommend that you read the props.conf description in the URL above if you&rsquo;re not familiar with it.</p>
<p># This is for data that we don&rsquo;t want ingested to Splunk
[lokirun]
DATETIME_CONFIG = CURRENT
LINE_BREAKER = ([\r\n]+)
SHOULD_LINEMERGE = false
disabled = 0
TRANSFORMS-null= setnull</p>
<p>#This entry parses the loki.exe &ldquo;CSV&rdquo; output
[loki]
TIME_PREFIX = ^
TIME_FORMAT = %Y%m%dT%H:%M:%SZ
MAX_TIMESTAMP_LOOKAHEAD = 25
DATETIME_CONFIG = CURRENT
LINE_BREAKER = ([\r\n]+)
SHOULD_LINEMERGE = false
disabled = 0</p>
<h1 id="example-log-20170219t154653zwin-8j1hppne2hbalertfile-cusersxdownloadsflokibot64a23908ade4bbf2a7c4aa31be3cff24-score-100-type-exe-size-400896-first_bytes-4d5a90000300000004000000ffff0000b8000000--mz-md5-64a23908ade4bbf2a7c4aa31be3cff24-sha1-2f87c2ce9ae1b741ac5477e9f8b786716b94afc5-sha256-a4a810eebd2fae1d088ee62af725e39717ead68140c4c5104605465319203d5e-created-tue-feb-07-134511-2017-modified-tue-feb-07-073700-2017-accessed-tue-feb-07-134511-2017reason_1-malware-hash-type-md5-hash-64a23908ade4bbf2a7c4aa31be3cff24-subscore-100-desc-flokibot-invades-pos-trouble-in-brazil">Example Log: 20170219T15:46:53Z,WIN-8J1HPPNE2HB,ALERT,FILE: C:\Users\x\Downloads\FlokiBot\64a23908ade4bbf2a7c4aa31be3cff24 SCORE: 100 TYPE: EXE SIZE: 400896 FIRST_BYTES: 4d5a90000300000004000000ffff0000b8000000 / MZ MD5: 64a23908ade4bbf2a7c4aa31be3cff24 SHA1: 2f87c2ce9ae1b741ac5477e9f8b786716b94afc5 SHA256: a4a810eebd2fae1d088ee62af725e39717ead68140c4c5104605465319203d5e CREATED: Tue Feb 07 13:45:11 2017 MODIFIED: Tue Feb 07 07:37:00 2017 ACCESSED: Tue Feb 07 13:45:11 2017REASON_1: Malware Hash TYPE: MD5 HASH: 64a23908ade4bbf2a7c4aa31be3cff24 SUBSCORE: 100 DESC: Flokibot Invades PoS: Trouble in Brazil <a href="https://www.arbornetworks.com/blog/asert/flokibot-invades-pos-trouble-brazil/">https://www.arbornetworks.com/blog/asert/flokibot-invades-pos-trouble-brazil/</a></h1>
<h1 id="extract-00-header-extracts-the-properly-csv-values-at-the-start-of-the-log-and-the-report-00-keyvalues-transformsconf-entry-parses-the-rest-of-the-line">EXTRACT-00-HEADER extracts the properly CSV values at the start of the log, and the REPORT-00-KEYVALUES transforms.conf entry parses the rest of the line.</h1>
<p>EXTRACT-00-HEADER = ^(?<!-- raw HTML omitted -->\d+)T(?<!-- raw HTML omitted -->\d+:\d+:\d+)Z,(?<!-- raw HTML omitted -->[^,]+),(?<!-- raw HTML omitted -->[^,]+),</p>
<h1 id="report-00-keyvalues-is-responsible-for-parsing-the-remaining-portion-of-the-loki-event-log-not-parsed-by-extract-00-header-transformsconf-is-good-at-parsing-repeating-values-such-as-xy--z-patterns-which-is-how-loki-outputs-its-scan-results">REPORT-00-KEYVALUES is responsible for parsing the remaining portion of the Loki event log not parsed by EXTRACT-00-HEADER. transforms.conf is good at parsing repeating values (such as &ldquo;x=y&rdquo; * z patterns), which is how Loki outputs its scan results.</h1>
<p>REPORT-00-KEYVALUES = trans_keyvalues</p>
<p><strong><em>$SPLUNK_HOME\etc\deployment_apps\Splunk_</em><strong><strong><em>App</em></strong></strong><em>_loki\default\<a href="http://docs.splunk.com/Documentation/Splunk/latest/Admin/Transformsconf">transforms.conf</a></em></strong><br>
A little on transforms.conf - it is commonly used for:</p>
<ul>
<li>Configuring regex-based host and source type overrides;</li>
<li>Anonymizing certain types of sensitive incoming data, such as credit card or social security numbers;</li>
<li>Routing specific events to a particular index, when you have multiple indexes;</li>
<li>Creating new index-time field extractions. NOTE: We do not recommend adding to the set of fields that are extracted at index time unless it is absolutely necessary because there are negative performance implications;</li>
<li>And a lot more&hellip;</li>
</ul>
<p>Like props.conf, transforms.conf is an integral configuration file to an app and I recommend that you read up on the URL to better understand the configuration file&rsquo;s function.</p>
<p># This is supposed to remove Loki&rsquo;s process bar entries
[setnull]
REGEX = ^[\\\|\-\/\b]+$
DEST_KEY = queue
FORMAT = nullQueue</p>
<h1 id="this-removes-the-lokiexe-execution-entry">This removes the loki.exe execution entry</h1>
<p>[setnull2]
REGEX = ^.*?\\etc\\apps\\loki\\bin&gt;loki\.exe &ndash;reginfs &ndash;csv &ndash;dontwait &ndash;onlyrelevant &ndash;intense\s+$
DEST_KEY = queue
FORMAT = nullQueue</p>
<h1 id="regex--xxx-parses-the-keyvalue-pattern-that-isnt-comma-separated-by-performing-a-look-ahead-to-detect-the-next-key-entry">&ldquo;REGEX = XXX&rdquo; parses the &ldquo;key=value&rdquo; pattern that isn&rsquo;t comma separated by performing a look ahead to detect the next &ldquo;key=&rdquo; entry.</h1>
<h1 id="format--12-tells-splunk-that-the-keyvalue-is-to-be-formatted-based-on-the-first-group-that-the-regex-extracts-as-the-key-and-the-second-group-that-the-regex-extracts-as-the-value">FORMAT = $1::$2 tells Splunk that the key/value is to be formatted based on the first group that the regex extracts as the key, and the second group that the regex extracts as the value.</h1>
<h1 id="message-me-if-you-would-like-a-deeper-breakdown-of-how-this-works-and-i-would-be-happy-to-explain-it">Message me if you would like a deeper breakdown of how this works, and I would be happy to explain it.</h1>
<p>[trans_keyvalues]
REGEX = ([\w\d]+):\s(.*?)(?=((\s[\d\w]+:\s)|$))
FORMAT = $1::$2</p>
<p>And that&rsquo;s it! Simple, right? It may be overwhelming if you&rsquo;re new to Splunk apps, but the main thing that you should know is that inputs.conf runs loki.bat (that runs loki.exe) and monitors for the loki.log file to be updated with the scan results. props.conf parses the first half of the Loki event log, and transforms.conf parses the rest. Hopefully this is helpful, but if you need more information feel free to message me on <a href="https://twitter.com/Epicism1">twitter</a> and I can provide more details.</p>
<p>Now we have a full app in your Splunk deployment server, re-deploy your deployment server apps using the command:</p>
<p>$SPLUNK_HOME/bin/splunk reload deploy-server</p>
<p>Now you should be able to see Splunk_App_loki in your Deployment server. Go to <em>Settings</em> -&gt; <em>Forwarder Management</em> -&gt; <em>Apps</em>, find <strong>Splunk_App_loki</strong> and click <em><strong>Edit</strong></em>.</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj43Wg8f0hJqQh2y7JRjaz46VV3BAYGExd1nXDz5TGrK_Ttxvce2Ml8-zh6U9WH9FKtlAajLjIu3Ip9mo-WsVGU_9p_TZvdZA5TVBblpHf9OmctYwpGJS8l6C5UT1TF6WAkRphVyYSfv6Da/s1600/Loki+Server.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj43Wg8f0hJqQh2y7JRjaz46VV3BAYGExd1nXDz5TGrK_Ttxvce2Ml8-zh6U9WH9FKtlAajLjIu3Ip9mo-WsVGU_9p_TZvdZA5TVBblpHf9OmctYwpGJS8l6C5UT1TF6WAkRphVyYSfv6Da/s640/Loki&#43;Server.PNG" alt="" />
</figure>


</a></p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoIU20TDtI3WGAOtVoAwN9eNI6vybQyEFlwl4RRlyGJSTRnabaJm0croEvlCwcDFpBFWEgh1Ez3W14zHS-6fw6NFyI5qfFT9dqpwgK4xb1QIXVug56ZaN802vr6cEj4Qu_HIHTQSLoZM-Z/s1600/Loki+Server+Properties.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoIU20TDtI3WGAOtVoAwN9eNI6vybQyEFlwl4RRlyGJSTRnabaJm0croEvlCwcDFpBFWEgh1Ez3W14zHS-6fw6NFyI5qfFT9dqpwgK4xb1QIXVug56ZaN802vr6cEj4Qu_HIHTQSLoZM-Z/s640/Loki&#43;Server&#43;Properties.PNG" alt="" />
</figure>


</a></p>
<p>Once in the App configuration section select the <strong><em>Reset Splunk</em></strong> checkbox and select <strong><em>Save</em></strong>.</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiN5sN0GH5FCPiyKaDE_K1ks94vnv4bwFwEWCSr2EMRz9wQ_umat6ram198DV5uMAfqzyhQ7UoajKgXbHmT2vu8BgNMjVXjEPqQeH2_D-lo3rHOvbEkeMNiM6OXcicKnqDEDXOYqJyf6Rsl/s1600/Loki+App.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiN5sN0GH5FCPiyKaDE_K1ks94vnv4bwFwEWCSr2EMRz9wQ_umat6ram198DV5uMAfqzyhQ7UoajKgXbHmT2vu8BgNMjVXjEPqQeH2_D-lo3rHOvbEkeMNiM6OXcicKnqDEDXOYqJyf6Rsl/s640/Loki&#43;App.PNG" alt="" />
</figure>


</a></p>
<p>Next go to the <em>Server Class</em> tab and create a new App by slicking <strong><em>New Server Class</em></strong>.</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjYMtnTz2HNkiBVkLd1jrivIEmiYV91jeS-szqVeDkvvJRvVGSz-MaG-V1DA0t-CR0lEc9c9cEH_41UGdaWeSMZFUp9ZbKsFDdiVvYfP5epHWC4q3UYrkWOayXqEEvfEoWTT2SEtZ9VqBQZ/s1600/New+App+Class.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjYMtnTz2HNkiBVkLd1jrivIEmiYV91jeS-szqVeDkvvJRvVGSz-MaG-V1DA0t-CR0lEc9c9cEH_41UGdaWeSMZFUp9ZbKsFDdiVvYfP5epHWC4q3UYrkWOayXqEEvfEoWTT2SEtZ9VqBQZ/s640/New&#43;App&#43;Class.PNG" alt="" />
</figure>


</a></p>
<p>Name it Loki_App_Class (or whatever you want) and click <strong><em>OK</em></strong>. This will bring you to the Loki App Class screen:</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhMbUfXiBLaj1hB9sClUyuFMeG0u1KwjEidllRL1lQiWDmRCxPJEm-wFTEPK1sCJTJjfCjoyXThCe2ZM5g6DuWmltiP7xQqqnoPWrHvOIF-QHJvpp2oRB4zOt0HKLmB3J4NNPDhm7XbDHPO/s1600/App+Class.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhMbUfXiBLaj1hB9sClUyuFMeG0u1KwjEidllRL1lQiWDmRCxPJEm-wFTEPK1sCJTJjfCjoyXThCe2ZM5g6DuWmltiP7xQqqnoPWrHvOIF-QHJvpp2oRB4zOt0HKLmB3J4NNPDhm7XbDHPO/s640/App&#43;Class.PNG" alt="" />
</figure>


</a></p>
<p><em>Note, if you chose to create the Splunk_TA_loki app, you can perform the same steps as above and add your search head to the clients list, or using the cluster manager.</em></p>
<p>In the Apps section select of the page click <em>Edit</em> to take you to the App list page. Click on the <strong><em>Splunk_App_loki</em></strong> app in the left hand side list to add it to the app class and click <strong><em>Save</em></strong>:</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjhVZ2_WPpFT5XyvFj_jwywEyRT0nkzhJP07p9rH64xaCnjIX58sIrUC3mqziXFlxjkB_8k8snUeBt1XBT1RG7EHHUnXZ2LCF7c50VA_u1M2vnvfJ99dak0L2x0yr0hrlsJpu2p6N23iBSJ/s1600/Loki+Apps+List.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjhVZ2_WPpFT5XyvFj_jwywEyRT0nkzhJP07p9rH64xaCnjIX58sIrUC3mqziXFlxjkB_8k8snUeBt1XBT1RG7EHHUnXZ2LCF7c50VA_u1M2vnvfJ99dak0L2x0yr0hrlsJpu2p6N23iBSJ/s640/Loki&#43;Apps&#43;List.PNG" alt="" />
</figure>


</a></p>
<p>This will take you back to the Loki_App_Class page. Next you will add the clients that you want to run the Loki APT scanner on. Click the <strong><em>Edit</em></strong> button on the Clients section of the page to take you to the list of clients (e.g. Splunk servers and Splunk Universal Forwarder servers). Add the Windows clients that you want to run Loki on on a regular schedule by adding their hostname to the <em>Include (whitelist)</em> textbox and click the <strong><em>Save</em></strong> button:</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjiqvzKGUeeXYosFY3cic3P5towoj7pmHToy9bnuKFkTzldIsS5H20zsUjzkw3rRcz7OPH4i_gCHMIWc_GmrDfn6JXD6sEusjM3nuZa3UfaWuZQS5Tg78YTw3luQl_ZrDsobfMqvuWu0Nlf/s1600/Loki+Client+List.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjiqvzKGUeeXYosFY3cic3P5towoj7pmHToy9bnuKFkTzldIsS5H20zsUjzkw3rRcz7OPH4i_gCHMIWc_GmrDfn6JXD6sEusjM3nuZa3UfaWuZQS5Tg78YTw3luQl_ZrDsobfMqvuWu0Nlf/s640/Loki&#43;Client&#43;List.PNG" alt="" />
</figure>


</a></p>
<p>This will cause the clients in the Include (whitelist) of the  Loki_App_Class to download, install and run the Loki app the next time they call in to the deployment server every day at 2:00 AM, save the results to &ldquo;$SPLUNK_HOME\var\log\splunk\loki.log&rdquo; and then ingest and parse the results into Splunk, taking the following:</p>
<p>20170417T01:36:13Z,WIN-8J1HPPNE2HB,ALERT,FILE: C:\Program Files\SplunkUniversalForwarder\var\log\splunk\loki.log SCORE: 4630 TYPE: UNKNOWN SIZE: 281385 FIRST_BYTES: 32303137303431375430313a33333a33365a2c57 / 20170417T01:33:36Z,W MD5: 99bb9f6343fc69159a6e03e1ef8c6428 SHA1: 58bf43a5c0ec496e62f2217cfa789df35d1ea953 SHA256: 4e1feaa3b24529737fa5accda9beaa841fb259ed5474087aa1017f8427544c04 CREATED: Sun Apr 16 18:33:36 2017 MODIFIED: Sun Apr 16 18:34:46 2017 ACCESSED: Sun Apr 16 18:33:36 2017REASON_1: Yara Rule MATCH: GRIZZLY_STEPPE_Malware_2 SUBSCORE: 70 DESCRIPTION: Auto-generated rule - file 9acba7e5f972cdd722541a23ff314ea81ac35d5c0c758eb708fb6e2cc4f598a0 MATCHES: Str1: GoogleCrashReport.dll Str2: CrashErrors Str3: CrashSend Str4: CrashAddData Str5: CrashCleanup Str6: CrashInitREASON_2: Yara Rule MATCH: Casper_Included_Strings SUBSCORE: 50 DESCRIPTION: Casper French Espionage Malware - String Match in File - <a href="http://goo.gl/VRJNLo">http://goo.gl/VRJNLo</a> MATCHES: Str1: cmd.exe /C FOR /L %%i IN (1,1,%d) DO IF EXIST Str2: &amp; SYSTEMINFO) ELSE EXIT Str3: jpic.gov.sy Str4: perfaudio.dat</p>
<p>20170417T01:38:59Z,WIN-8J1HPPNE2HB,WARNING,FILE: C:\Users\Administrator\AppData\Local\Google\Chrome\User Data\Default\Cache\f_0000ab SCORE: 70 TYPE: RAR SIZE: 257998 FIRST_BYTES: 526172211a0700cf907300000d00000000000000 / Rar!s MD5: b7bec1fe35e86afc5b00f2b72f684406 SHA1: c875243df43d7a0baababf7488df884acffae2f9 SHA256: f1209bbd5163a03c4543607a1ce2c69548fa6bddc977670fad845fc42216c69f CREATED: Mon Feb 06 09:11:44 2017 MODIFIED: Mon Feb 06 09:11:44 2017 ACCESSED: Mon Feb 06 09:11:44 2017REASON_1: Yara Rule MATCH: Cloaked_RAR_File SUBSCORE: 70 DESCRIPTION: RAR file cloaked by a different extension</p>
<p>and turning it into parsed key/value pairs that can be used to run reports that show all Loki Scan results that have a 70% confidence level and above, or to fire an alert on confidence levels of 100% :</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgLw48pXjJqlBb2br4YjkLVyDgijCDJCuS7g2NYQh6uvScQnpadM2_FYoxLFIyyhuwHtNGv2B-QjqWt7fJ_b3EbAvXep0LObmMUC-6XYZWOa8SIHjLlIZooR6-_d8WzziLblA1YAZxN7n5y/s1600/Loki+logs.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgLw48pXjJqlBb2br4YjkLVyDgijCDJCuS7g2NYQh6uvScQnpadM2_FYoxLFIyyhuwHtNGv2B-QjqWt7fJ_b3EbAvXep0LObmMUC-6XYZWOa8SIHjLlIZooR6-_d8WzziLblA1YAZxN7n5y/s640/Loki&#43;logs.PNG" alt="" />
</figure>


</a></p>
<p>Loki Parsed Logs</p>
<p><strong>Conclusion</strong><br>
This is great, but, really, so what? What can we do with this information? The value in this post is in creating the ability to automate a manual task across your your enterprise. You no longer have to manually run the Loki APT scanner on each system across your environment and parse through the results for possible issues. Automate, explore, expand, exploit, and exterminate (if I&rsquo;m getting my <a href="https://en.wikipedia.org/wiki/4X">references</a> correct). With a sea of open source security tools that work well on a manual process, this solution can be an excellent method to provide a fresh insight into the workings, and malevolent workings, of an enterprise.</p>
<h4 id="source"><a href="https://www.redblue.team/feeds/6924840910220312139/comments/default">Source</a></h4>
<!-- raw HTML omitted -->

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/2025-03-20-laser-harp-sets-the-tone/">Laser Harp Sets the Tone</a></li>
				
				<li><a href="/posts/2025-03-20-arduino-device-helps-split-the-g-on-a-p/">Arduino device helps split the G on a pint of Guinness</a></li>
				
				<li><a href="/posts/2025-03-20-the-70-best-early-amazon-spring-sale-ga/">The 70 best early Amazon Spring Sale gaming deals 2025</a></li>
				
				<li><a href="/posts/2025-03-20-tomorrow-and-tomorrow-and-tomorrow-info/">Tomorrow and tomorrow and tomorrow Information security and the Baseball Hall of Fame</a></li>
				
				<li><a href="/posts/2025-03-20-i-found-an-android-phone-that-can-convi/">I found an Android phone that can convince iPhone users to make the switch - and its not a flagship</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2025 <a href="https://ghariib.ir/"><b>Alireza Gharib. All right reserved</b></a>.
	<a href="https://github.com/Gharib110"><b>Github</b></a>.
	</p>
</footer>

</body>
</html>
