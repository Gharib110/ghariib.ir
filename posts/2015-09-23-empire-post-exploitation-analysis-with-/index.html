<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Empire Post-Exploitation Analysis with Rekall and PowerShell Windows Event Logs</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
	==========================<br>
	== <a href="https://ghariib.ir/">Gharib Personal Blog</a> ==<br>
	==========================
	<div style="float: right;">A Techi Personal Blog</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Posts</b></a>.
			
			<a href="/categories/"><b>Categories</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Empire Post-Exploitation Analysis with Rekall and PowerShell Windows Event Logs</h1>
			<b><time>23.09.2015 18:59</time></b>
		       

			<div>
				<h1 id="empire-post-exploitation-analysis-with-rekall-and-powershell-windows-event-logs">Empire Post-Exploitation Analysis with Rekall and PowerShell Windows Event Logs</h1>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Although Empire is only a couple of months old, the developers (who also worked on <a href="https://www.veil-framework.com/">Veil</a>) have built an impressive lightweight management architecture that borrows heavily from projects like PowerSploit and PowerTools to create a &ldquo;pure PowerShell post-exploitation agent built on cryptographically-secure communications and a flexible architecture.&rdquo; While working with it the past couple of days I have found that it has a familiar workflow for those who are accustomed to Metasploit, making it easy to use for penetration testing Windows environments.</p>
<p>I have used Metasploit for many years, dabbled with Core Impact, and explored Armitage/Cobalt Strike at great length. These are all fantastic frameworks that are incredibly extensible, have strong community support and regular development release cycles. But the PowerSploit framework isn&rsquo;t exactly &lsquo;built-in&rsquo; to those solutions (Cobalt Strike allows you to import modules making it perhaps the easiest to extend in terms of PowerShell based attacks). I&rsquo;ve had a few conversations recently with people who are unsure about what framework they should be using and my answer is always the same, it depends. What you select is largely dependent on financial limitations and objectives but in the end it is probably best that you get familiar with all of these offerings.</p>
<p>There are a couple of key features in Empire:</p>
<ul>
<li>Invoke Expression and Web Client download cradles allow you to stay off disk as much as possible. Evading on-access scanners is crucial and leaving as few forensic artifacts as possible is just good trade-craft.</li>
<li>The agent beacons in a cryptographically secure manner and in a way that effectively emulates command and control traffic.</li>
</ul>
<p>As penetration testers our goal should be to effectively mimic real-world attack methodologies, network traffic and end-point activity to provide clients with a set of indicators of compromise that can be effectively used to identify monitoring gaps. Tools like Empire help to push these ideas forward and reduce the latency between attacker innovation and defender evolution.</p>
<p>In this post I want to demonstrate how to use Empire, conduct basic IR memory analysis (in the same format as my previous article) and, more importantly, highlight some discussion around automated detection at the network and host level.</p>
<p><strong>Red Team</strong></p>
<p>I used Kali (2.0) for my server but I&rsquo;m sure this would work on most Debian based distributions.</p>
<blockquote>
<p><em>git clone https://github.com/PowerShellEmpire/Empire.git</em><br>
<em>cd Empire/setup</em><br>
<em>./install.sh</em></p></blockquote>
<p>Simple. To launch Empire, execute the following command from the Empire root directory with the -debug switch enabled to ensure logs are stored for troubleshooting and tracing your activity:</p>
<blockquote>
<p><em>./empire -debug</em></p></blockquote>
<p>Empire uses the concept of listeners, stagers and agents. A listener is a network socket instantiated on the server side that manages connections from infected agents. A stager is the payload you intend to deliver to the victim machine. To access your listeners simply type <em>‘listeners’</em> to enter the listeners context, followed by <em>‘info’.</em></p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiY6jcxw5Qpxt3T8jBMcJ3Bz8UPPOpxgnhHb5l3af7EIrkjVtZWoc0XE0ENHDKiYWJ57EpRGAXUOFpHMtILBlYtIZmIpkBMYPmWNG0WfrHx0yviH8i-xKCMwe94HnfotO8EbTO9cVRlzEw/s1600/listeners.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiY6jcxw5Qpxt3T8jBMcJ3Bz8UPPOpxgnhHb5l3af7EIrkjVtZWoc0XE0ENHDKiYWJ57EpRGAXUOFpHMtILBlYtIZmIpkBMYPmWNG0WfrHx0yviH8i-xKCMwe94HnfotO8EbTO9cVRlzEw/s320/listeners.PNG" alt="" />
</figure>


</a></p>
<p>There are a few important values to note here. First, you can specify a KillDate and WorkingHours to limit agent and listener activity based on project limitations. I have certainly worked on a number of engagements in which a client had very specific restrictions about when we could work, which would have proved invaluable.</p>
<p>Second, the DefaultJitter value will help evade solutions that attempt to identify malicious beacon patterns that occur at a constant interval, and imply scripted or machine like activity that obviously stands out from natural human browsing patterns. There is also a DefaultProfile that defines the communication pattern that the agent uses to beacon home, which we will talk more about later.</p>
<p>Third, define variables using <em>&lsquo;set [variablename] [value]&rsquo;</em> syntax, and activate the listener with the &rsquo;execute&rsquo; command . Type list to verify that the listener is active and a network socket has been opened.</p>
<p>Logically the next step is define a payload and select a payload delivery mechanism. Type <em>&lsquo;usestager&rsquo;</em>  followed by TAB+TAB to see a list of options.</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiFLolxQKQq_Fu33DroDdyT1wdcZnp57h-yuSzi71w8snN-cAVy9oj4mu4IbmyNMt7xAkTvDz2sTs_SN-oL2CJ1RLU_gFYUgTpNccrZLOyuoIB-OxaWrcDOLfhLZEE1ILF9LKOwCx3PBiE/s1600/stagers+available.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiFLolxQKQq_Fu33DroDdyT1wdcZnp57h-yuSzi71w8snN-cAVy9oj4mu4IbmyNMt7xAkTvDz2sTs_SN-oL2CJ1RLU_gFYUgTpNccrZLOyuoIB-OxaWrcDOLfhLZEE1ILF9LKOwCx3PBiE/s320/stagers&#43;available.PNG" alt="" />
</figure>


</a></p>
<p>The two options that are best suited for payload execution are launcher and macro. Launcher will generate a PowerShell one-liner (Base64 encoded or clear text) that automatically sets the required staging key/listener values. Macro creates an office macro with the appropriate callback values to establish a connection with the listener. This can be embedded in an office document and used in social engineering attacks as a payload delivery mechanism. </p>
<p>To select a stager type <em>&lsquo;usestager [stagername] [listenername]&rsquo;</em> followed by <em>&rsquo;execute&rsquo;</em>. </p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiF8ahPqmEIj1kGxQ9F9X24JnyWfabI7p3PLrbq-i44IUL51KsjPnd8RdnHgRgqJaXQIM6gOp1ln8tI5Ni8evGcaYHDZW7APPB-DXlQrKp_UEIvEZtvOxMsHdrVLVmv87yKpB65S2Nwdl4/s1600/stager+enc+vs+nonenc.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiF8ahPqmEIj1kGxQ9F9X24JnyWfabI7p3PLrbq-i44IUL51KsjPnd8RdnHgRgqJaXQIM6gOp1ln8tI5Ni8evGcaYHDZW7APPB-DXlQrKp_UEIvEZtvOxMsHdrVLVmv87yKpB65S2Nwdl4/s320/stager&#43;enc&#43;vs&#43;nonenc.PNG" alt="" />
</figure>


</a></p>
<p>In the image above you can see that the listener callback details are embedded in the script, and a (possibly) hard-coded value of /index.asp is used for the agent GET request. The session value for the agent is included. Base64 encoding the script will turn on the &lsquo;-Enc&rsquo; PowerShell flag which will decrypt the payload at run-time making investigation and tractability more difficult (again, simulating a real breach.) </p>
<p>After executing this one-liner on our victim machine you will receive a callback notification that a new connection has been established. You can observe active agents by typing <em>&lsquo;agents&rsquo;</em> followed by &lsquo;<em>list&rsquo;.</em> </p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgWLtcBkRUUW0W5zgxuqvJUwZI5388eRj-vycx739n6i1R7rhwLNfnsyFKNtPnz5nwf_DM5HBOZox2VwfxVbS9wYqI2MVXUpD7tp8aVS16Inx2lBK5OWkFV4ZsXopaLqz8j9x0GdS7XtU8/s1600/active+stager.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgWLtcBkRUUW0W5zgxuqvJUwZI5388eRj-vycx739n6i1R7rhwLNfnsyFKNtPnz5nwf_DM5HBOZox2VwfxVbS9wYqI2MVXUpD7tp8aVS16Inx2lBK5OWkFV4ZsXopaLqz8j9x0GdS7XtU8/s320/active&#43;stager.PNG" alt="" />
</figure>


</a></p>
<p>Now that a connection is established you can type <em>&lsquo;interact [agentname]&rsquo;</em> to hop into an agent session similar to meterpreter. Enter <em>&lsquo;usemodule&rsquo;</em> followed by TAB+TAB to see all available options. You can identify privilege escalation opportunities, move laterally, establish persistence, steal tokens/credentials, install key-loggers and run all of the amazing post exploitation tasks available from the PowerSploit/PowerTools exploitation kits. I don&rsquo;t want to go into detail for each of these modules as it is not the intent of this post. I simply wanted to demonstrate how to get up and running to encourage more offensive-security professionals to embrace this tool. </p>
<p><strong>Blue Team</strong></p>
<p>My objective for the defensive aspect of this post is to conduct some high level analysis of the tool itself and the general methods it employs. There are a lot of modules available and of course each of these may leave behind specific indicators of attack/compromise but it&rsquo;s not my goal to go into each of them for this post.</p>
<p>Let&rsquo;s take a look at some of the network traffic first.</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhKGLE4yK7_SOAzYrhbk2UMUUaEaL0LpW3oohfWvGo7HG5EsfFui3Mxrt6dt6Zvp2KqtD9MFei5Jlf9EhA1rWdmAmRfsZJQE5QeG2fFamDpfuDaltvQHFHJtgiBaHROjckcVCFn_eU6Iy8/s1600/initial+URI.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhKGLE4yK7_SOAzYrhbk2UMUUaEaL0LpW3oohfWvGo7HG5EsfFui3Mxrt6dt6Zvp2KqtD9MFei5Jlf9EhA1rWdmAmRfsZJQE5QeG2fFamDpfuDaltvQHFHJtgiBaHROjckcVCFn_eU6Iy8/s320/initial&#43;URI.PNG" alt="" />
</figure>


</a></p>
<p>We see that after the initial stager is executed our first connection is established. On its own this is an extremely poor indicator. GET requests to /index.asp are going to be very common on any network. However, it does appear to be a hard-coded value and it&rsquo;s important to gather as much information as possible. </p>
<p>After this initial connection a second stage payload is downloaded, key negotiation occurs, an encrypted session is established and the agent starts beaconing. This beacon is characterized by the DefaultProfile variable set for the listener running on the Empire server. </p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjJvXFulptQhscakGOjRr55x_cWqM4MxseOxmzj6f3W2QGHbVW2UpqjlCpQ0TOwIadK6pFkj-Z2P4rKIysopkK8hfpCeUjDeHs9lYb1tc7X4c-OmGLP-MqNhxurJkqrr0hx4s2gAZ0e6L4/s1600/beacon+pattern.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjJvXFulptQhscakGOjRr55x_cWqM4MxseOxmzj6f3W2QGHbVW2UpqjlCpQ0TOwIadK6pFkj-Z2P4rKIysopkK8hfpCeUjDeHs9lYb1tc7X4c-OmGLP-MqNhxurJkqrr0hx4s2gAZ0e6L4/s320/beacon&#43;pattern.PNG" alt="" />
</figure>


</a></p>
<p>We can see the beacon issues 3 GET requests within a short period of time during a call home interval. The requests are sent to /news.asp, /admin/get.php, /login/process.jsp and have a generic Mozilla User-Agent.</p>
<p>Again, individually each of these actions appears benign and alerting on it would generate a significant number of false positives (which is the intention of the framework.) If we look at this traffic collectively we could design a network IDS rule that alerts when a connection is made to /index.ASP and is followed by at least three GET requests to at least two of the GET requests in the image above.</p>
<p>Moreover, many organizations may issue tight controls around the type of Browser application that can be installed, and it is unlikely to see a Windows server with Firefox running. If you are a system administrator that has implemented application white-listing and your users should only be using IE, the presence of Mozilla/Chrome/Opera UA indicates a policy violation (best case scenario) or a manually crafted UA (worst case possibly indicating malware). In any event, it is possible to at least use this information to profile other infected hosts even if it doesn&rsquo;t serve as a point of initial detection. It&rsquo;s good to have options.</p>
<p>Of course all of this can be customized in Empire, so from a heuristic perspective I think the important take away really is recognizing the pattern itself and not necessarily the specific implementation of that pattern. That is a little bit esoteric so let&rsquo;s try and gather more information from the host.</p>
<p>Dave recently published a <a href="http://www.redblue.team/2015/09/spotting-adversary-with-windows-event.html">two</a> <a href="http://www.redblue.team/2015/09/spotting-adversary-with-windows-event_21.html">part</a> series on Windows event monitoring. This is a fantastic starting point for most organizations, especially those who are new to SIEM. I still come across a lot of environments that do not have any formal log management program, let alone a properly deployed SIEM with a good alerting framework that has been adequately tuned. For most companies, implementing monitoring for the event IDs Dave highlighted is a good objective. But for those with a more mature security program, I think it&rsquo;s important to start looking at PowerShell events.</p>
<p>PowerShell 2.0 is the default installed version for Windows 7 and Server 2008 R2 (prior versions do not have PowerShell installed) and unfortunately it does not provide much information from a logging perspective.</p>
<p>There are primarily two log files that are accessible:</p>
<ul>
<li>Microsoft Windows PowerShell</li>
<li>Microsoft Windows PowerShell Operational</li>
</ul>
<p>It is also possible to enable analytic and debug logging however this is fairly noisy and resource intensive. Open Event Viewer and select View -&gt; Show Analytic and Debug Logs. Then browse Application and Service Logs -&gt; Microsoft -&gt; Windows -&gt; PowerShell and right click Analytic to enable it. I don&rsquo;t think there is a lot of value add here but it can be useful when debugging a script or troubleshooting a problem.</p>
<p>In the 2.0 version of the Microsoft Windows PowerShell Operational log you will have the following events of interest:</p>
<ul>
<li>40961 - Console is starting up</li>
<li>40962 - Console is ready for user input</li>
</ul>
<p>These logs do contain meta information such as the user who performed the event, and the computer it was executed on but it is pretty limited. If you do not use PowerShell in your environment (even small organizations have use cases so this is unlikely) then perhaps alerting on one of these events may be useful but there is very little contextual data stored in the event log to indicate what was done while the console was accessed.</p>
<p>The Microsoft Windows PowerShell log in version 2.0 of PowerShell will often generate these event IDs:</p>
<ul>
<li>600 - Provider Life-cycle</li>
<li>400 - Engine Life-cycle</li>
<li>403 - Engine Life-cycle</li>
</ul>
<p>Again these events are fairly nondescript and provide little information. </p>
<p>Event ID 5156 from the Windows Security audit log can provide some additional information regarding network connections if we effectively filter to alert on Outbound, external, connections generated from applications like powershell.exe.  </p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvNNdxDkA5p2e7cAWm8ZIUNtbJjZOAEVQu7KZIILrSA-ZxmTD-L2HrKBcuEb59_mVjJEADc-lLC822pIXKaBH86dKMiNrzoskK1ek3ZuA1TwB9BNms0ybOkUvjCH0I13R6rOGfOVXDVkw/s1600/powershell+event+log+connection.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvNNdxDkA5p2e7cAWm8ZIUNtbJjZOAEVQu7KZIILrSA-ZxmTD-L2HrKBcuEb59_mVjJEADc-lLC822pIXKaBH86dKMiNrzoskK1ek3ZuA1TwB9BNms0ybOkUvjCH0I13R6rOGfOVXDVkw/s320/powershell&#43;event&#43;log&#43;connection.PNG" alt="" />
</figure>


</a></p>
<p>None of these indicators are of any substantial quality, but thankfully Microsoft introduced some improvements in version 3.0 of PowerShell (no additional changes to event logging functionality in version 4.0 or 5.0 unfortunately).</p>
<p>After upgrading to PowerShell version 3.0 you can specify a GPO setting to turn on module logging for Windows PowerShell modules in all sessions of all affected computers. Pipeline execution events for the selected modules will then be recorded in the PowerShell event logs I covered earlier. You can also interactively enable these values as shown below. This is shown in the image below:</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiF2DkccpDSME8aG0C3gQUkeuJPJqxxkO0bHPk6OO7OJxmy931G_pCiFDzcQSy3FzhPpGvvucuJr4IAq7tDhvpt1t_BSzHO1i_Ky8W0D0tmKNOwUR0QdMD9Ff6A4GnWR-fZRAuotYnTT1U/s1600/powershell+logging+settings.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiF2DkccpDSME8aG0C3gQUkeuJPJqxxkO0bHPk6OO7OJxmy931G_pCiFDzcQSy3FzhPpGvvucuJr4IAq7tDhvpt1t_BSzHO1i_Ky8W0D0tmKNOwUR0QdMD9Ff6A4GnWR-fZRAuotYnTT1U/s320/powershell&#43;logging&#43;settings.PNG" alt="" />
</figure>


</a></p>
<p>If we now execute our PowerShell Empire one-line stager we will have more event log data to work with. Event IDs 4103 and 800 are recorded and contain a veritable wealth of information that can be used to detect suspicious activity. </p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidKTxySpFUwW_Tl26c9mbI8hzpWM8_sNAchcraw8fBw9G77ScXmgnAsKCGF8_a795FfRqPJTGDc21soz4jJkrrMIrqThCA8RUsN-ThBPADEOq4SjhNAxidMeSIklr9qZEWSlJ3XHPy9Bs/s1600/pipelineexecutionlogpowershell.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidKTxySpFUwW_Tl26c9mbI8hzpWM8_sNAchcraw8fBw9G77ScXmgnAsKCGF8_a795FfRqPJTGDc21soz4jJkrrMIrqThCA8RUsN-ThBPADEOq4SjhNAxidMeSIklr9qZEWSlJ3XHPy9Bs/s320/pipelineexecutionlogpowershell.PNG" alt="" />
</figure>


</a></p>
<p>At this point we can launch Rekall, list processes, identify suspect network connections, dump process memory and perform keyword string searches.</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjtU6minHPSfiBv9jx7wiW6JNfn9VIi7lrZYzwtrR9ecpsvREorCaoWl1q4nWxrgFJwUKT3dQtjobxvfdMl3bbxX0t9oT8ZMKspS0SdaOmQfLRxPeJ34rS77x1Ag0JmDvOtvVhc6OTX0ho/s1600/rekall+launch.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjtU6minHPSfiBv9jx7wiW6JNfn9VIi7lrZYzwtrR9ecpsvREorCaoWl1q4nWxrgFJwUKT3dQtjobxvfdMl3bbxX0t9oT8ZMKspS0SdaOmQfLRxPeJ34rS77x1Ag0JmDvOtvVhc6OTX0ho/s320/rekall&#43;launch.PNG" alt="" />
</figure>


</a></p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi0Ck9kr57ctHGwgF13x3ooHZBL1E2vsfVWUMiMgHiS1Zcab6QJX_bSGkiaNs8_aO9CKgfjqwx4iOgqbnlZRJVsBEZQQxqDKvyj74nbIJmRRHW6NpmtWAFEd0YI8ZCqf4ugPMeSLobtjdA/s1600/powershell+beacon.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi0Ck9kr57ctHGwgF13x3ooHZBL1E2vsfVWUMiMgHiS1Zcab6QJX_bSGkiaNs8_aO9CKgfjqwx4iOgqbnlZRJVsBEZQQxqDKvyj74nbIJmRRHW6NpmtWAFEd0YI8ZCqf4ugPMeSLobtjdA/s320/powershell&#43;beacon.PNG" alt="" />
</figure>


</a></p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_z7_95JwLeh8hmpRG7410IhgXrr2gdjpAR0qdvarAFHhKVz5v7Uhi3Ooe6uyK-RfEZz-OMRpDOFBQNOx9JkLscofsz9WEzAiv7sHeH8qbkrfXZUZi7kJ7QryDJl_LMcv0auw3CYCJT1o/s1600/powershell+rekall+memdump+pid.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_z7_95JwLeh8hmpRG7410IhgXrr2gdjpAR0qdvarAFHhKVz5v7Uhi3Ooe6uyK-RfEZz-OMRpDOFBQNOx9JkLscofsz9WEzAiv7sHeH8qbkrfXZUZi7kJ7QryDJl_LMcv0auw3CYCJT1o/s320/powershell&#43;rekall&#43;memdump&#43;pid.PNG" alt="" />
</figure>


</a></p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj7O-1vY0ojBDJ0K7OBsh4O3fl22uUjlI8bwrOLyXyr6HxBhI8SDOam6X-rpJWlJ5H7GUqrBohkD9V_9NhgmveELDNW53snV_wlQdey-l_93c3G67G-JCh6vTIBROUQ5AN6I5b5XH4pY14/s1600/powershellmemdump.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj7O-1vY0ojBDJ0K7OBsh4O3fl22uUjlI8bwrOLyXyr6HxBhI8SDOam6X-rpJWlJ5H7GUqrBohkD9V_9NhgmveELDNW53snV_wlQdey-l_93c3G67G-JCh6vTIBROUQ5AN6I5b5XH4pY14/s320/powershellmemdump.PNG" alt="" />
</figure>


</a></p>
<p>This is a similar workflow to my prior post. In large memory dumps it can be difficult (time consuming) to navigate or CTRL+F search through a document for specific keywords. Mark Russinovich&rsquo;s <a href="https://technet.microsoft.com/en-us/sysinternals/bb897439.aspx">strings</a> can greatly reduce this work effort but a better solution in my opinion is to write <a href="http://plusvic.github.io/yara/">Yara</a> rules and use them in conjunction with Volatility. If you aren&rsquo;t familiar, Yara is a tool designed to help execute binary or textual pattern match searches. It is very easy to write rules as the syntax is easy to pick up. Save the following to a text file with the .YARA extension.</p>
<p>rule example : powershell</p>
<p>{   </p>
<p>     meta:</p>
<p>           Description = &ldquo;Look for suspect powershell artificats.&rdquo;</p>
<p>           filetype = &ldquo;MemoryDump&rdquo;         </p>
<p>           Author = &ldquo;Greg Carson&rdquo;</p>
<p>           Date = &ldquo;09-09-2015&rdquo;</p>
<p>     strings:</p>
<p>           $s0 = &ldquo;Invoke-&rdquo; ascii</p>
<p>           $s1 = &ldquo;-Enc&rdquo; ascii</p>
<p>     condition:</p>
<p>           2 of them</p>
<p>}</p>
<p>This can then be imported to perform a search in Volatility:</p>
<p>vol.py -f image.raw &ndash;profile=Win7SP1x64 yarascan -y yarafilename.yara -p 7860</p>
<p>The workflow demonstrated on the Blue Team side of things isn&rsquo;t necessarily in any order. Ideally, you would have a SIEM rule trigger based on a suspicious pipeline execution PowerShell event (that has appropriate filters and suppression enabled), which results in an investigation of network traffic prior to and shortly after the event and is followed by a more thorough live memory forensic analysis of the system and others it may have had contact with. But this may not be possible depending on the environment you find yourself in. It&rsquo;s important not to rely on any one single security solution as the indicators of attack will often exist in many different places and across disparate entities that solve different problems.</p>
<p>EDIT:<br>
@tifkin_ contacted me to mention an additional tool from Mark Russinovich titled &lsquo;<a href="http://www.darkoperator.com/blog/2014/8/8/sysinternals-sysmon">Sysmon</a>&rsquo;. It&rsquo;s a little bit outside the scope of this post but the tool itself shows a lot of promise, I&rsquo;d recommend defenders look into this.</p>
<p>Related Links:</p>
<p><a href="https://technet.microsoft.com/en-us/library/cc749492.aspx">https://technet.microsoft.com/en-us/library/cc749492.aspx</a></p>
<p><a href="http://plusvic.github.io/yara/">http://plusvic.github.io/yara/</a></p>
<p><a href="http://www.powershellempire.com/">http://www.powershellempire.com/</a></p>
<p><a href="http://www.rekall-forensic.com/">http://www.rekall-forensic.com/</a></p>
<p><a href="https://www.blackhat.com/docs/us-14/materials/us-14-Kazanciyan-Investigating-Powershell-Attacks-WP.pdf">https://www.blackhat.com/docs/us-14/materials/us-14-Kazanciyan-Investigating-Powershell-Attacks-WP.pdf</a></p>
<p><a href="https://www.petri.com/enable-powershell-logging">https://www.petri.com/enable-powershell-logging</a></p>
<p><a href="https://technet.microsoft.com/en-us/library/hh857339.aspx">https://technet.microsoft.com/en-us/library/hh857339.aspx</a></p>
<p><a href="http://learn-powershell.net/2014/08/26/more-new-stuff-in-powershell-v5-extra-powershell-auditing/">http://learn-powershell.net/2014/08/26/more-new-stuff-in-powershell-v5-extra-powershell-auditing/</a></p>
<p><a href="https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/">https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/</a></p>
<h4 id="source"><a href="https://www.redblue.team/feeds/1190017291351937718/comments/default">Source</a></h4>
<!-- raw HTML omitted -->

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/2025-03-20-laser-harp-sets-the-tone/">Laser Harp Sets the Tone</a></li>
				
				<li><a href="/posts/2025-03-20-arduino-device-helps-split-the-g-on-a-p/">Arduino device helps split the G on a pint of Guinness</a></li>
				
				<li><a href="/posts/2025-03-20-the-70-best-early-amazon-spring-sale-ga/">The 70 best early Amazon Spring Sale gaming deals 2025</a></li>
				
				<li><a href="/posts/2025-03-20-tomorrow-and-tomorrow-and-tomorrow-info/">Tomorrow and tomorrow and tomorrow Information security and the Baseball Hall of Fame</a></li>
				
				<li><a href="/posts/2025-03-20-i-found-an-android-phone-that-can-convi/">I found an Android phone that can convince iPhone users to make the switch - and its not a flagship</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2025 <a href="https://ghariib.ir/"><b>Alireza Gharib. All right reserved</b></a>.
	<a href="https://github.com/Gharib110"><b>Github</b></a>.
	</p>
</footer>

</body>
</html>
