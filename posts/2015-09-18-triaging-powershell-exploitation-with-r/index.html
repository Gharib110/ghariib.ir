<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Triaging PowerShell Exploitation with Rekall</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
	==========================<br>
	== <a href="https://ghariib.ir/">Gharib Personal Blog</a> ==<br>
	==========================
	<div style="float: right;">A Techi Personal Blog</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Posts</b></a>.
			
			<a href="/categories/"><b>Categories</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Triaging PowerShell Exploitation with Rekall</h1>
			<b><time>18.09.2015 00:12</time></b>
		       

			<div>
				<h1 id="triaging-powershell-exploitation-with-rekall">Triaging PowerShell Exploitation with Rekall</h1>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>I&rsquo;ve spent a fair bit of time in EnCase. They have a great product and a number of solutions to fit most of your needs, but at times it can feel bulky and a little stiff. Moreover, it has an arguably non-intuitive user interface and is an expensive solution that a lot of organizations cannot afford. Volatility is fantastic but for this post I wanted to focus specifically on Rekall. Incident Response and Forensics require a superb understanding of operating system internals, file system structures, and malware behavior patterns, but tools like Volatility and Rekall greatly reduce the barrier to entry for security analysts and service providers.</p>
<p><a href="http://www.rekall-forensic.com/">Rekall</a> is a complete end to end memory forensics framework (branched from <a href="https://github.com/volatilityfoundation">Volatility</a> itself). The developers of this project wanted to focus on improving modularity, usability, and performance. One of the most significant advantages to using Rekall is that at allows for local or remote <em>live</em> forensic analysis. For this reason it is a core component of the <a href="https://github.com/google/grr">Google Rapid Response</a> tool.</p>
<p>In this article I wanted to document a common offensive tactic and then briefly step through some investigatory steps. This is by no means a complete incident response process, and the scenario assumes the attacker has some level of access to the system or network already.</p>
<p><strong>Red Team</strong><br>
I am a big fan of Matt Graeber&rsquo;s <a href="https://github.com/mattifestation/PowerSploit">PowerSploit</a>. PowerSploit is essentially a set of PowerShell scripts designed to aid penetration testers during all phases of an assessment. You can use it to inject DLLs, reflectively load PE files, insert shellcode, bypass anti-virus, load Mimikatz and do all sorts of other wonderful and nefarious things. PowerShell has become extremely popular as an attack vector in the last two years as it is a native trusted process, lacks comprehensive security mechanisms (excluding perhaps the most recent versions), and is an extremely powerful scripting language (direct API support for Windows internals).</p>
<p>In our scenario we assume that the attacker has a limited shell and wants to gain more significant access. First let&rsquo;s set up our listener:</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTUm5oKx85SkAwh7inVEznvsggwOM2xYD6x_dvKzqJyY3ZeEjnKkqzos1ByvcX5EImmEyG6-a7ONlHHWgazxRNWpqG1afvPaelgIP6aFhfe2e8dUi6YHjEJ3hTuwe8xxt90LMopHcrJz8/s1600/msflistener.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTUm5oKx85SkAwh7inVEznvsggwOM2xYD6x_dvKzqJyY3ZeEjnKkqzos1ByvcX5EImmEyG6-a7ONlHHWgazxRNWpqG1afvPaelgIP6aFhfe2e8dUi6YHjEJ3hTuwe8xxt90LMopHcrJz8/s400/msflistener.PNG" alt="" />
</figure>


</a></p>
<p>I&rsquo;ve elected to use the Reverse_HTTPS Meterpreter payload as the PowerSploit Invoke-Shellcode script used later on only supports the Reverse_HTTPS and Reverse_HTTP variants (and as such it is preferable to pass this traffic over SSL).</p>
<p>On the compromised machine we will now execute a PowerShell one-liner to retrieve the Invoke-Shellcode PS1 script from the PowerSploit GitHub page. This is a nice method of retrieval as GitHub is not a suspicious or inherently untrustworthy page and the request is submitted over HTTPS (which can help with evasion at the URL filtering/web traffic content inspection layers). Additional levels of evasion can be employed by encrypting our PS1 script but I&rsquo;m not going to explore that option for the purposes of this demo.</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_iWjzH2M0C_BVTJXCO_3T2B2vcN3YCV7dyt_WSPAGmnvV0DIHoYBvXU0FLBpDo0N7sunM8NyikvqlYwSIkM2LOI3f-gjwzKmvKr9AXAxjIOBgLGiLOOqhg9yKAMkpuqPYnIhWF7grBds/s1600/powershell+cradle.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_iWjzH2M0C_BVTJXCO_3T2B2vcN3YCV7dyt_WSPAGmnvV0DIHoYBvXU0FLBpDo0N7sunM8NyikvqlYwSIkM2LOI3f-gjwzKmvKr9AXAxjIOBgLGiLOOqhg9yKAMkpuqPYnIhWF7grBds/s400/powershell&#43;cradle.PNG" alt="" />
</figure>


</a></p>
<p>What&rsquo;s happening here? PowerShell is calling IEX (Invoke-Expression) to generate a new WebClient object and calls the DownloadString function to retrieve the URL. The Invoke-Shellcode script is executed with the switches that will instantiate a connection to our MSF listener. This is all executed in the context of the PowerShell process itself.</p>
<p>In Metasploit we see a session is established and migrate processes. In this example I am migrating to Notepad. This is not good trade-craft and I&rsquo;m only doing this to make things more discernible and easy to grasp forensically in the next section.</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiawm1BfOSKeNdMqpvHQybjlrB2ga8ZnIyhdp5opDA0Ua8ZCBp5wZY0drkLWv8E6AUoDv-uwkfZEVxkRDM89cKz_4vHYLECKefltK4md5QEsABvDsll-FtXaxBhP4V74_1paxlpDs9ikk0/s1600/reverse+shell+established.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiawm1BfOSKeNdMqpvHQybjlrB2ga8ZnIyhdp5opDA0Ua8ZCBp5wZY0drkLWv8E6AUoDv-uwkfZEVxkRDM89cKz_4vHYLECKefltK4md5QEsABvDsll-FtXaxBhP4V74_1paxlpDs9ikk0/s400/reverse&#43;shell&#43;established.PNG" alt="" />
</figure>


</a></p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhM2f7Bs4YTk-OI6mPC-OFuhdfpDLlqNyUAdTA5SvZEJbTfOsjR0VVr5HVTcqOzfz9JtJ8QsJuQy5B6OdraV3WxdCy5VG87S8WKbPPxwk-bs8V94hK4nKA89SE2e9LsmCae39cLzB49ZA8/s1600/migrate.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhM2f7Bs4YTk-OI6mPC-OFuhdfpDLlqNyUAdTA5SvZEJbTfOsjR0VVr5HVTcqOzfz9JtJ8QsJuQy5B6OdraV3WxdCy5VG87S8WKbPPxwk-bs8V94hK4nKA89SE2e9LsmCae39cLzB49ZA8/s400/migrate.PNG" alt="" />
</figure>


</a></p>
<p>At this point we can start looking at things from the other perspective.</p>
<p><strong>Blue Team</strong></p>
<p>First let&rsquo;s drop WinPMem on the system. WinPMem is a kernel mode driver that allows us to gain access to physical memory and map it is a device. </p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjXylWr1vmRzMH5CRKGBAo7mALL2vVb9-sW5aGUSVJ3n27eEqiUjoN61jSm1sV0h_Pmlaf9r4iwP1vHA85gvb8hesrSXnmn7mMuMiztivHcChly7b6vfgwI5O7-Ki9JIi-bf0yvhYTwihw/s1600/winpmem.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjXylWr1vmRzMH5CRKGBAo7mALL2vVb9-sW5aGUSVJ3n27eEqiUjoN61jSm1sV0h_Pmlaf9r4iwP1vHA85gvb8hesrSXnmn7mMuMiztivHcChly7b6vfgwI5O7-Ki9JIi-bf0yvhYTwihw/s400/winpmem.PNG" alt="" />
</figure>


</a></p>
<p>Once this is done we can use Rekall to perform live memory forensics on the system. Navigate to your Rekall install directory and run the following command to mount the WinPMem device:</p>
<blockquote>
<p><em>rekall.exe -f \\.\pmem</em></p></blockquote>
<p>This will launch a Rekall interactive console.  Rekall has support for a lot of native plugins (that you are likely familiar with if you have ever used Volatility). Typing plugins. [tab] [tab] will print a list of options. To get additional information type plugins.[pluginname]? Many plugins also have switches that allow you to filter your query based on a specified criteria. To see the list of available switches type pluginname [tab].</p>
<p>A good starting point is the <em>netscan</em> plugin. </p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi0GYtffcBtG0DTt-FxZBPu0Oqclnhmu-lQWN70AfFDT-vD9s9roAJpRmrytCxACS3r58Jj3VItnoy9Qnbmw2XzJXjDqtLNX7Yp6RRLkmitMX9M0zwwbwK3BwzNMTZi1i_NeWRJ0fwo5zU/s1600/start+netscan.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi0GYtffcBtG0DTt-FxZBPu0Oqclnhmu-lQWN70AfFDT-vD9s9roAJpRmrytCxACS3r58Jj3VItnoy9Qnbmw2XzJXjDqtLNX7Yp6RRLkmitMX9M0zwwbwK3BwzNMTZi1i_NeWRJ0fwo5zU/s400/start&#43;netscan.PNG" alt="" />
</figure>


</a></p>
<p>You should also run pslist when starting your analysis to understand what processes are running. Nothing out of the ordinary but as we continue to browse we see Notepad has a network socket established:</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjC0HWXMpjpkAIs89Phxi-by937T51PxC_qlyh-cm6wwhZdB4QZgkVEL9JWhAtqq9xs7QKZj_v1gOv-5Y6Ua1qSbLypGnoqtNUMm4ZEswgSvBmH3vEEVX4nDO1hF2NAHVhyPon5UXjKkMw/s1600/notepad+beacon.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjC0HWXMpjpkAIs89Phxi-by937T51PxC_qlyh-cm6wwhZdB4QZgkVEL9JWhAtqq9xs7QKZj_v1gOv-5Y6Ua1qSbLypGnoqtNUMm4ZEswgSvBmH3vEEVX4nDO1hF2NAHVhyPon5UXjKkMw/s320/notepad&#43;beacon.PNG" alt="" />
</figure>


</a></p>
<p>It is clear that this process has been hooked as Notepad should never establish network connections. Let&rsquo;s use the LDRModules plugin to detect unlinked DLLs.</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhQhLj8RhSBkDMwFYOrVgN_8Lsny2SDxz6NtKFjrC0tII-tK5B0HgKeiRja5-4WL2vW8W32V7-05XgEyEtmDJk7-fyh_gEM5jn9OqCKTy8uYJqWUclm1Xyg9QoN9QEQQ7tmPJlHZyY6YZg/s1600/unlinked+dlls.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhQhLj8RhSBkDMwFYOrVgN_8Lsny2SDxz6NtKFjrC0tII-tK5B0HgKeiRja5-4WL2vW8W32V7-05XgEyEtmDJk7-fyh_gEM5jn9OqCKTy8uYJqWUclm1Xyg9QoN9QEQQ7tmPJlHZyY6YZg/s400/unlinked&#43;dlls.PNG" alt="" />
</figure>


</a></p>
<p>We see a list of unlinked DLLs and some that stand out as extremely suspicious. So we know that Notepad was injected into by a different process (or spawned by malware using a technique known as process hollowing). Obviously for this example we know that Meterpreter migrated to this process.</p>
<p>Meterpreter has a fairly standard migration process:</p>
<ol>
<li>Identify the PID.</li>
<li>Scan for architecture of target process.</li>
<li>Check if the SeDebugPrivilege is set to get handle to target process.</li>
<li>Calculate payload length.</li>
<li>Call OpenProcess() to gain access to Virtual Memory of target process.</li>
<li>Call VirtualAllocEx() to assign PAGE_EXECUTE_READWRITE.</li>
<li>Call WriteProcessMemory() to write the payload into the target process allocated memory region.</li>
<li>Call CreateRemoteThread() to execute the payload.</li>
<li>Close the prior thread from the old Meterpreter session.</li>
</ol>
<p>In knowing this we look for additional suspect processes. I like to look for cmd.exe or powershell.exe and dump these processes memory regions for string analysis. When I ran pslist earlier I identified a PowerShell process and ran the memdump pid=[PowerShellPID] plugin. This will produce a DMP file that you can load in your favorite editor.  </p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjG1HqWCNAOxc7x6si1dG4hlEUoY4KO2BsMaASZGK8tMiLVjEpa44WVvr2o_hyphenhypheng2-pvgxrAHGST-eXddOKUTSApwnC3W10FKPHrq_lcUjUChQBTptfHELCo2JR4G5Fn3RH9heUPs4LWtAM/s1600/powershell+process+dump.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjG1HqWCNAOxc7x6si1dG4hlEUoY4KO2BsMaASZGK8tMiLVjEpa44WVvr2o_hyphenhypheng2-pvgxrAHGST-eXddOKUTSApwnC3W10FKPHrq_lcUjUChQBTptfHELCo2JR4G5Fn3RH9heUPs4LWtAM/s400/powershell&#43;process&#43;dump.PNG" alt="" />
</figure>


</a></p>
<p>I was able to find suspicious strings by searching for keywords such as &lsquo;IEX&rsquo;, &lsquo;Download&rsquo;, and other commands that might be used by an attacker. At this point I am able to extract the full PowerSploit script from memory and have identified that my attacker downloaded a Meterpreter stager. From an Incident Response perspective we have numerous Indicators of Compromise to work with.</p>
<p>Lastly, ProcExplorer from Mark Russinovich is a great tool for at a glance identification of suspect activity. Let&rsquo;s look at spawned threads and stack information from a normal Notepad process relative to a hooked one:</p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg7qzC4oct4nnsVHYGXT9rjtWyejuG6lkF-eg8_L9fGwTwRBr75ktqEOxOMTuljbMYOjTNj0-5F2vU9RGKXTNvjVtLUT4j3EAZ4bNaGvIVUP8wGX8xutqoUtt9eK1-oTbuiGBSiBZx3_pc/s1600/notepad+process.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg7qzC4oct4nnsVHYGXT9rjtWyejuG6lkF-eg8_L9fGwTwRBr75ktqEOxOMTuljbMYOjTNj0-5F2vU9RGKXTNvjVtLUT4j3EAZ4bNaGvIVUP8wGX8xutqoUtt9eK1-oTbuiGBSiBZx3_pc/s320/notepad&#43;process.PNG" alt="" />
</figure>


</a></p>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhhH1-9T_eT3bANrBA380IreIWzBRN9pUYYBpLwYHsNSKVI3qH9a80udgYmbV-PFsE0txZwuGu8kBQWFZjpNTrsfD0y8I8rfhX4FjqKu7a5IouNIeXd5yxBSOrqjl2NyBSIDcF4vTK-WY4/s1600/additionalnotepadthreads.PNG">
<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhhH1-9T_eT3bANrBA380IreIWzBRN9pUYYBpLwYHsNSKVI3qH9a80udgYmbV-PFsE0txZwuGu8kBQWFZjpNTrsfD0y8I8rfhX4FjqKu7a5IouNIeXd5yxBSOrqjl2NyBSIDcF4vTK-WY4/s320/additionalnotepadthreads.PNG" alt="" />
</figure>


</a></p>
<p>This is by no means a complex attack and there is much more we can do from a memory analysis perspective, but I think the material covered serves as a gentle introduction to the topic. I&rsquo;ll likely follow up on this post in the future and go into more depth but hopefully this information is enough to get you started.</p>
<p>There are a number of fantastic writers covering these types of topics in the blogosphere and I wanted to link to them here as they are all doing amazing work. I came across some great posts while doing research:<br>
<a href="http://holisticinfosec.blogspot.ca/2015/05/toolsmith-attack-detection-hunting-in.html">http://holisticinfosec.blogspot.ca/2015/05/toolsmith-attack-detection-hunting-in.html</a><br>
<a href="http://www.tekdefense.com/news/2013/12/23/analyzing-darkcomet-in-memory.html">http://www.tekdefense.com/news/2013/12/23/analyzing-darkcomet-in-memory.html</a><br>
<a href="http://www.behindthefirewalls.com/2013/07/zeus-trojan-memory-forensics-with.html">http://www.behindthefirewalls.com/2013/07/zeus-trojan-memory-forensics-with.html</a><br>
<a href="https://github.com/volatilityfoundation">https://github.com/volatilityfoundation</a><br>
<a href="http://www.rekall-forensic.com/">http://www.rekall-forensic.com/</a><br>
<a href="https://github.com/google/grr">https://github.com/google/grr</a><br>
<a href="https://github.com/google/rekall/releases/tag/v1.3.2">https://github.com/google/rekall/releases/tag/v1.3.2</a></p>
<h4 id="source"><a href="https://www.redblue.team/feeds/5175046893973570049/comments/default">Source</a></h4>
<!-- raw HTML omitted -->

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/2025-03-20-laser-harp-sets-the-tone/">Laser Harp Sets the Tone</a></li>
				
				<li><a href="/posts/2025-03-20-arduino-device-helps-split-the-g-on-a-p/">Arduino device helps split the G on a pint of Guinness</a></li>
				
				<li><a href="/posts/2025-03-20-the-70-best-early-amazon-spring-sale-ga/">The 70 best early Amazon Spring Sale gaming deals 2025</a></li>
				
				<li><a href="/posts/2025-03-20-tomorrow-and-tomorrow-and-tomorrow-info/">Tomorrow and tomorrow and tomorrow Information security and the Baseball Hall of Fame</a></li>
				
				<li><a href="/posts/2025-03-20-i-found-an-android-phone-that-can-convi/">I found an Android phone that can convince iPhone users to make the switch - and its not a flagship</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2025 <a href="https://ghariib.ir/"><b>Alireza Gharib. All right reserved</b></a>.
	<a href="https://github.com/Gharib110"><b>Github</b></a>.
	</p>
</footer>

</body>
</html>
