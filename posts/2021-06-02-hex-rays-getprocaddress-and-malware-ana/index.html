<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Hex-Rays GetProcAddress and Malware Analysis</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
	==========================<br>
	== <a href="https://ghariib.ir/">Gharib Personal Blog</a> ==<br>
	==========================
	<div style="float: right;">A Techi Personal Blog</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Posts</b></a>.
			
			<a href="/categories/"><b>Categories</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Hex-Rays GetProcAddress and Malware Analysis</h1>
			<b><time>02.06.2021 00:10</time></b>
		       

			<div>
				<h1 id="hex-rays-getprocaddress-and-malware-analysis">Hex-Rays GetProcAddress and Malware Analysis</h1>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h1 id="background">Background</h1>
<p>Hex-Rays v7.4 introduced special handling for <code>GetProcAddress</code>. We can see the difference &ndash; several of them, actually &ndash; in the following two screenshots. The first comes from Hex-Rays 7.1:</p>
<p>
<figure>
  <img src="https://images.squarespace-cdn.com/content/v1/53a64cc2e4b0c63fc41a3320/1622591294913-ECKXWT79SLSJJ3Y4P68W/HR71.png?format=1000w" alt="" />
</figure>


</p>
<p>The second comes from Hex-Rays 7.6:</p>
<p>
<figure>
  <img src="https://images.squarespace-cdn.com/content/v1/53a64cc2e4b0c63fc41a3320/1622591347166-XGTP0AWV9QHDOWFUNB69/HR76.png?format=1000w" alt="" />
</figure>


</p>
<p>Several new features are evident in the screenshots &ndash; more aggressive variable mapping eliminating the first two lines, and automatic variable renaming changing the names of variables &ndash; but the one this entry focuses on has to do with the type assigned to the return value of <code>GetProcAddress</code>. Hex-Rays v7.4+ draw upon IDA&rsquo;s type libraries to automatically resolve the name of the procedure to its proper function pointer type signature, and set the return type of <code>GetProcAddress</code> to that type.</p>
<p>This change is evident in the screenshots above: for 7.1, the variable is named <code>v7</code>, its type is the generic <code>FARPROC</code>, and the final line shows a nasty cast on the function call. For 7.6, the variable is named <code>IsWow64Process</code>, its type is <code>BOOL (__stdcall *)(HANDLE, PBOOL)</code> (the proper type signature for the <code>IsWow64Process</code> API), and the final line shows no cast. Beyond the casts, we can also see that applying the type signature also changes the types of other local variables: <code>v5</code> in the first has the generic type <code>int</code>, whereas <code>v5</code> has the proper type <code>BOOL</code> in the second.</p>
<p>These screenshots clearly demonstrate that IDA is capable of resolving an API name to its proper type signature, the desirable effects of applying the proper type signature on readability, and the secondary effects of setting the types of other variables involved in calling those APIs.</p>
<h1 id="relevance-to-malware-analysis">Relevance to Malware Analysis</h1>
<p>Hex-Rays&rsquo; built-in functionality won&rsquo;t work directly when malware looks up API names by hash, or uses encrypted strings for the API names: the decompiler must see a fixed string being passed to <code>GetProcAddress</code> to do its magic. Although the malware analysis community seems very comfortable in dealing with imports via hash and encrypted strings, they seem less comfortable with applying proper type signatures to the resultant variables and structure members. <a href="https://cyber.wtf/2019/03/22/using-ida-python-to-analyze-trickbot/">Only one publication</a> I&rsquo;m aware of bothers to tackle this, and it relies upon manual effort to retrieve the type definitions and create <code>typedef</code>s for them. This is unfortunate, as applying said types dramatically cleans up the decompilation output, but this is understandable, as the manual effort involved is rather cumbersome.</p>
<p>As a result, most publications that encounter this problem feature screenshots like this one. Note all of the casts on the function pointer invocations, and the so-called &ldquo;partial types&rdquo; <code>_QWORD</code>, etc.:</p>
<p>
<figure>
  <img src="https://images.squarespace-cdn.com/content/v1/53a64cc2e4b0c63fc41a3320/1622591586565-RRF2GE1J5AXZ9BGA3GUR/AnalysisWithCasts.png?format=1000w" alt="" />
</figure>


</p>
<p>(I chose not to link the analysis from which the above screenshot was lifted, because my goal here is positive assistance to the malware analysis community, and not to draw negative attention to anyone&rsquo;s work in particular. This pattern is extremely frequent throughout presentations of malware analysis; it is immaterial who authored the screenshot above, and I had other examples to choose from.)</p>
<h1 id="the-solution">The Solution</h1>
<p>I did not know how to resolve an API name to its type signature, so I simply reverse engineered how Hex-Rays implements the functionality mentioned at the top of this entry. The result is a function <code>PrintTypeSignature(apiName)</code> you can use in your scripts and day-to-day work that does what its name implies: retrieves and prints the type signature for an API specified by name.</p>
<p>The script includes a demo function <code>Demo()</code> that resolves a number of API type signatures and prints them to the console. It begins by declaring a list of strings:</p>
<p>
<figure>
  <img src="https://images.squarespace-cdn.com/content/v1/53a64cc2e4b0c63fc41a3320/1622592018876-M54KYI7EVS4Z5YDGX5FY/PyDemo.png?format=1000w" alt="" />
</figure>


</p>
<p>The output of the script is the type signatures, ready to be copied and pasted into the variable type window and/or a structure declaration.</p>
<p>
<figure>
  <img src="https://images.squarespace-cdn.com/content/v1/53a64cc2e4b0c63fc41a3320/1622592053867-QVSG8K7LETOQZETV0YD0/ScriptOutput.png?format=1000w" alt="" />
</figure>


</p>
<h1 id="gui">GUI</h1>
<p>I decided to add a small GUI to the functionality. After you run <a href="https://github.com/RolfRolles/Miscellaneous/blob/master/APIRetypeGUI.py">this plugin</a>, you will have a new entry on your Hex-Rays right-click menu that appears when your cursor is over a pointer-sized local variable, as follows:</p>
<p>
<figure>
  <img src="https://images.squarespace-cdn.com/content/v1/53a64cc2e4b0c63fc41a3320/1622661497790-TXHEY9941H697MPZ12MN/GUIMenu.png?format=1000w" alt="" />
</figure>


</p>
<p>Once you click on that, it will ask you to enter an API name:</p>
<p>
<figure>
  <img src="https://images.squarespace-cdn.com/content/v1/53a64cc2e4b0c63fc41a3320/1622661534792-7AL68IPVOL4TQ85S0331/GUIAsk.png?format=1000w" alt="" />
</figure>


</p>
<p>If there are no errors, the script will change the type of the variable to the function prototype for the API.</p>
<p>
<figure>
  <img src="https://images.squarespace-cdn.com/content/v1/53a64cc2e4b0c63fc41a3320/1622661585166-KFDPP3XKUPSI587CEAUS/GUIResult.png?format=1000w" alt="" />
</figure>


</p>
<h1 id="a-final-note">A Final Note</h1>
<p>Architecturally, there is a discrepancy between how the Hex-Rays microcode machinery handles type information for direct calls versus indirect ones. To summarize, you may still see casts in the output after applying the proper type signature to a variable or structure member. If this happens, right-click on the indirect call and press <code>Force call type</code> to force the proper type information to be applied at the call site. However, only do this once you have set the proper type information for the function pointer variable or structure member.</p>
<p>
<figure>
  <img src="https://images.squarespace-cdn.com/content/v1/53a64cc2e4b0c63fc41a3320/1622592099614-6EBKFS88I6XNX1HTXXN2/ForceCallType.png?format=1000w" alt="" />
</figure>


</p>
<p>Mostly I published this because I want to see more types applied, and fewer casts, in the malware analysis publications that I read. Please, use my script!</p>
<h1 id="addendum">Addendum</h1>
<p>After publishing this article, I was made aware of <a href="https://usualsuspect.re/article/ida-tricks-handling-dynamic-imports">prior work</a> that is strongly related. That work focuses on the same problem, albeit in the disassembly listing rather than in Hex-Rays (and hence does not discuss some of the considerations from my entry above). Its ultimate solution is very similar to mine; it includes two out of three API calls from the one I came up with in this entry.</p>
<h4 id="source"><a href="https://www.msreverseengineering.com/blog/2021/6/1/hex-rays-getprocaddress-and-malware-analysis">Source</a></h4>
<!-- raw HTML omitted -->

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/2025-03-20-laser-harp-sets-the-tone/">Laser Harp Sets the Tone</a></li>
				
				<li><a href="/posts/2025-03-20-arduino-device-helps-split-the-g-on-a-p/">Arduino device helps split the G on a pint of Guinness</a></li>
				
				<li><a href="/posts/2025-03-20-the-70-best-early-amazon-spring-sale-ga/">The 70 best early Amazon Spring Sale gaming deals 2025</a></li>
				
				<li><a href="/posts/2025-03-20-tomorrow-and-tomorrow-and-tomorrow-info/">Tomorrow and tomorrow and tomorrow Information security and the Baseball Hall of Fame</a></li>
				
				<li><a href="/posts/2025-03-20-i-found-an-android-phone-that-can-convi/">I found an Android phone that can convince iPhone users to make the switch - and its not a flagship</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2025 <a href="https://ghariib.ir/"><b>Alireza Gharib. All right reserved</b></a>.
	<a href="https://github.com/Gharib110"><b>Github</b></a>.
	</p>
</footer>

</body>
</html>
